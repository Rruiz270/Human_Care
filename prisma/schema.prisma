// Human Care - Holistic Care and Personal Development Platform
// Database Schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==================== USERS & AUTHENTICATION ====================

enum UserRole {
  ADMIN
  PROFESSOR
  TERAPEUTA
  COACH
  CARE_TEAM
}

enum InviteStatus {
  PENDING
  ACCEPTED
  EXPIRED
}

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  name          String
  avatar        String?
  role          UserRole  @default(PROFESSOR)
  phone         String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  isActive      Boolean   @default(true)

  // Life Map ownership (for professors)
  lifeMap       LifeMap?

  // Professional assignments
  assignedAsTherapist   CareTeamAssignment[] @relation("TherapistAssignments")
  assignedAsCoach       CareTeamAssignment[] @relation("CoachAssignments")
  assignedAsCareTeam    CareTeamAssignment[] @relation("CareTeamAssignments")

  // Sessions
  sessionsAsClient      Session[]  @relation("ClientSessions")
  sessionsAsProfessional Session[] @relation("ProfessionalSessions")

  // AI Chat
  chatMessages          ChatMessage[]

  // Invites sent
  invitesSent           Invite[]   @relation("InvitesSent")

  // Notes created
  notesCreated          Note[]

  @@map("users")
}

model Invite {
  id          String       @id @default(cuid())
  email       String
  role        UserRole     @default(PROFESSOR)
  status      InviteStatus @default(PENDING)
  token       String       @unique @default(cuid())
  expiresAt   DateTime
  createdAt   DateTime     @default(now())

  invitedBy   User         @relation("InvitesSent", fields: [invitedById], references: [id])
  invitedById String

  @@map("invites")
}

// ==================== LIFE MAP ====================

model LifeMap {
  id        String   @id @default(cuid())
  userId    String   @unique
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Past
  pastTimeline      TimelineEvent[]
  familyRelations   FamilyRelation[]
  beliefSystems     BeliefSystem[]

  // Present
  bodyHealth        BodyHealth?
  mindState         MindState?
  identity          Identity?
  currentRelations  CurrentRelation[]
  environments      Environment[]
  routines          Routine[]

  // Future
  purpose           Purpose?
  projects          Project[]
  okrs              OKR[]

  // Tracking
  dailyTracking     DailyTracking[]

  @@map("life_maps")
}

// ==================== PAST - Timeline & History ====================

enum TimelineEventType {
  ACHIEVEMENT      // Conquista (azul)
  TRAUMA           // Trauma (vermelho)
  LOSS             // Perda
  GAIN             // Ganho
  MILESTONE        // Marco importante
  RELATIONSHIP     // Evento de relacionamento
  HEALTH           // Evento de saude
  EDUCATION        // Educacao
  CAREER           // Carreira
  OTHER
}

model TimelineEvent {
  id          String            @id @default(cuid())
  lifeMapId   String
  lifeMap     LifeMap           @relation(fields: [lifeMapId], references: [id], onDelete: Cascade)

  title       String
  description String?           @db.Text
  eventType   TimelineEventType
  eventDate   DateTime?
  ageAtEvent  Int?              // Idade quando aconteceu
  impact      Int               @default(5) // 1-10 scale
  isPositive  Boolean           // true = azul, false = vermelho
  isResolved  Boolean           @default(false)

  // Related people
  relatedPeople String[]

  // Professional notes
  notes       Note[]

  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt

  @@map("timeline_events")
}

enum RelationType {
  FATHER
  MOTHER
  SIBLING
  SPOUSE
  CHILD
  GRANDPARENT
  UNCLE_AUNT
  COUSIN
  FRIEND
  OTHER
}

model FamilyRelation {
  id          String       @id @default(cuid())
  lifeMapId   String
  lifeMap     LifeMap      @relation(fields: [lifeMapId], references: [id], onDelete: Cascade)

  name        String
  relationType RelationType
  quality     Int          @default(5) // 1-10 quality of relationship
  description String?      @db.Text
  isAlive     Boolean      @default(true)
  influence   String?      @db.Text // How this person influenced
  blocks      String?      @db.Text // Blocks generated by this relationship

  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  @@map("family_relations")
}

model BeliefSystem {
  id          String   @id @default(cuid())
  lifeMapId   String
  lifeMap     LifeMap  @relation(fields: [lifeMapId], references: [id], onDelete: Cascade)

  belief      String
  origin      String?  @db.Text // Where this belief came from
  isLimiting  Boolean  @default(false)
  isWorkedOn  Boolean  @default(false)
  notes       String?  @db.Text

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("belief_systems")
}

// ==================== PRESENT - Current State ====================

model BodyHealth {
  id          String   @id @default(cuid())
  lifeMapId   String   @unique
  lifeMap     LifeMap  @relation(fields: [lifeMapId], references: [id], onDelete: Cascade)

  weight      Float?
  height      Float?
  sleepHours  Float?
  sleepQuality Int?    // 1-10
  exerciseFrequency String?
  healthConditions String[] // List of conditions
  medications String[]
  dietDescription String? @db.Text
  energyLevel Int?     // 1-10

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("body_health")
}

model MindState {
  id          String   @id @default(cuid())
  lifeMapId   String   @unique
  lifeMap     LifeMap  @relation(fields: [lifeMapId], references: [id], onDelete: Cascade)

  workDescription String?   @db.Text
  workHoursPerDay Float?
  stressLevel     Int?      // 1-10
  screenTimeHours Float?
  socialMediaUsage String?  @db.Text
  mainWorries     String[]
  copingMechanisms String[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("mind_states")
}

model Identity {
  id              String   @id @default(cuid())
  lifeMapId       String   @unique
  lifeMap         LifeMap  @relation(fields: [lifeMapId], references: [id], onDelete: Cascade)

  selfDescription String?  @db.Text // Como se ve
  values          String[] // Core values
  strengths       String[]
  weaknesses      String[]
  lifePhilosophy  String?  @db.Text

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@map("identities")
}

enum CurrentRelationType {
  ROMANTIC
  FAMILY
  PROFESSIONAL
  FRIENDSHIP
  MENTORSHIP
  OTHER
}

model CurrentRelation {
  id          String              @id @default(cuid())
  lifeMapId   String
  lifeMap     LifeMap             @relation(fields: [lifeMapId], references: [id], onDelete: Cascade)

  name        String
  relationType CurrentRelationType
  quality     Int                 @default(5) // 1-10
  frequency   String?             // How often they interact
  description String?             @db.Text
  challenges  String?             @db.Text

  createdAt   DateTime            @default(now())
  updatedAt   DateTime            @updatedAt

  @@map("current_relations")
}

model Environment {
  id          String   @id @default(cuid())
  lifeMapId   String
  lifeMap     LifeMap  @relation(fields: [lifeMapId], references: [id], onDelete: Cascade)

  name        String   // Ex: Casa, Trabalho, Academia
  type        String   // Tipo de ambiente
  satisfaction Int     @default(5) // 1-10
  timeSpent   String?  // Tempo gasto nesse ambiente
  description String?  @db.Text
  improvements String? @db.Text

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("environments")
}

model Routine {
  id          String   @id @default(cuid())
  lifeMapId   String
  lifeMap     LifeMap  @relation(fields: [lifeMapId], references: [id], onDelete: Cascade)

  dayOfWeek   Int?     // 0-6 (domingo-sabado), null = todos os dias
  wakeUpTime  String?
  bedTime     String?
  activities  Json     // Array of activities with times
  notes       String?  @db.Text
  version     Int      @default(1) // Track routine evolution

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("routines")
}

// ==================== FUTURE - Goals & Purpose ====================

model Purpose {
  id          String   @id @default(cuid())
  lifeMapId   String   @unique
  lifeMap     LifeMap  @relation(fields: [lifeMapId], references: [id], onDelete: Cascade)

  statement   String   @db.Text // Declaracao de proposito
  whyItMatters String? @db.Text
  dreams      String[] // Lista de sonhos
  legacy      String?  @db.Text // O que quer deixar

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("purposes")
}

enum ProjectStatus {
  PLANNING
  IN_PROGRESS
  ON_HOLD
  COMPLETED
  CANCELLED
}

model Project {
  id          String        @id @default(cuid())
  lifeMapId   String
  lifeMap     LifeMap       @relation(fields: [lifeMapId], references: [id], onDelete: Cascade)

  title       String
  description String?       @db.Text
  status      ProjectStatus @default(PLANNING)
  startDate   DateTime?
  targetDate  DateTime?
  completedAt DateTime?
  progress    Int           @default(0) // 0-100
  category    String?       // Career, Personal, Health, etc.

  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  @@map("projects")
}

model OKR {
  id          String     @id @default(cuid())
  lifeMapId   String
  lifeMap     LifeMap    @relation(fields: [lifeMapId], references: [id], onDelete: Cascade)

  objective   String
  quarter     String?    // Ex: Q1 2024
  year        Int?
  keyResults  KeyResult[]
  progress    Int        @default(0) // 0-100 calculated from key results
  notes       String?    @db.Text

  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  @@map("okrs")
}

model KeyResult {
  id          String   @id @default(cuid())
  okrId       String
  okr         OKR      @relation(fields: [okrId], references: [id], onDelete: Cascade)

  description String
  targetValue Float
  currentValue Float   @default(0)
  unit        String?  // Ex: %, horas, sessoes

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("key_results")
}

// ==================== DAILY TRACKING ====================

model DailyTracking {
  id          String   @id @default(cuid())
  lifeMapId   String
  lifeMap     LifeMap  @relation(fields: [lifeMapId], references: [id], onDelete: Cascade)

  date        DateTime @db.Date

  // Thoughts, Actions, Feelings
  thoughts    String?  @db.Text
  actions     String?  @db.Text
  feelings    String?  @db.Text

  // Metrics
  moodScore   Int?     // 1-10
  energyScore Int?     // 1-10
  stressScore Int?     // 1-10

  // Self-awareness
  insights    String?  @db.Text
  gratitude   String[]
  challenges  String[]

  // Purpose alignment
  alignedWithPurpose Boolean @default(false)
  alignmentNotes     String? @db.Text

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([lifeMapId, date])
  @@map("daily_tracking")
}

// ==================== CARE TEAM & SESSIONS ====================

model CareTeamAssignment {
  id          String   @id @default(cuid())

  clientId    String

  // Professionals
  therapistId String?
  therapist   User?    @relation("TherapistAssignments", fields: [therapistId], references: [id])

  coachId     String?
  coach       User?    @relation("CoachAssignments", fields: [coachId], references: [id])

  careTeamId  String?
  careTeam    User?    @relation("CareTeamAssignments", fields: [careTeamId], references: [id])

  isActive    Boolean  @default(true)
  startDate   DateTime @default(now())
  endDate     DateTime?
  notes       String?  @db.Text

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("care_team_assignments")
}

enum SessionType {
  THERAPY
  COACHING
  CARE_TEAM_CHECKIN
  COUPLES_THERAPY
  WORKSHOP
  OTHER
}

enum SessionStatus {
  SCHEDULED
  IN_PROGRESS
  COMPLETED
  CANCELLED
  NO_SHOW
}

model Session {
  id              String        @id @default(cuid())

  clientId        String
  client          User          @relation("ClientSessions", fields: [clientId], references: [id])

  professionalId  String
  professional    User          @relation("ProfessionalSessions", fields: [professionalId], references: [id])

  type            SessionType
  status          SessionStatus @default(SCHEDULED)

  scheduledAt     DateTime
  startedAt       DateTime?
  endedAt         DateTime?
  duration        Int?          // In minutes

  // Location
  isOnline        Boolean       @default(true)
  meetingLink     String?
  location        String?

  // Content
  transcript      String?       @db.Text
  transcriptFile  String?       // File path/URL

  // AI Analysis
  aiAnalysis      Json?         // Structured analysis from AI
  aiSummary       String?       @db.Text
  aiActionItems   Json?         // Array of action items
  aiInsights      Json?         // Key insights extracted

  // Professional notes
  notes           Note[]

  // Missions/Tasks generated
  missions        Mission[]

  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  @@map("sessions")
}

model Note {
  id          String         @id @default(cuid())

  authorId    String
  author      User           @relation(fields: [authorId], references: [id])

  sessionId   String?
  session     Session?       @relation(fields: [sessionId], references: [id])

  timelineEventId String?
  timelineEvent   TimelineEvent? @relation(fields: [timelineEventId], references: [id])

  content     String         @db.Text
  isPrivate   Boolean        @default(false) // Only visible to professionals

  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt

  @@map("notes")
}

enum MissionStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum MissionType {
  THERAPY_TASK    // Curar algo do passado
  COACHING_TASK   // Construir algo para o futuro
  DAILY_HABIT     // Habito diario
  REFLECTION      // Reflexao
  ACTION          // Acao especifica
}

model Mission {
  id          String        @id @default(cuid())

  sessionId   String?
  session     Session?      @relation(fields: [sessionId], references: [id])

  title       String
  description String?       @db.Text
  type        MissionType
  status      MissionStatus @default(PENDING)

  dueDate     DateTime?
  completedAt DateTime?

  // Progress tracking
  checkIns    Json?         // Array of check-in notes

  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  @@map("missions")
}

// ==================== AI CHAT ====================

enum ChatRole {
  USER
  ASSISTANT
  SYSTEM
}

model ChatMessage {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id])

  role        ChatRole
  content     String   @db.Text

  // Context
  context     Json?    // Additional context sent to AI

  createdAt   DateTime @default(now())

  @@map("chat_messages")
}

// ==================== METRICS & ANALYTICS ====================

model CareMetrics {
  id              String   @id @default(cuid())
  lifeMapId       String

  date            DateTime @db.Date

  // Care ratio tracking
  professionalCareHours Float @default(0)
  artificialCareMinutes Float @default(0)
  selfCareMinutes       Float @default(0)

  // Session counts
  therapySessions  Int     @default(0)
  coachingSessions Int     @default(0)
  careTeamCheckIns Int     @default(0)

  // Progress indicators
  purposeAlignment Int?    // 1-10
  overallWellbeing Int?    // 1-10

  createdAt       DateTime @default(now())

  @@unique([lifeMapId, date])
  @@map("care_metrics")
}
